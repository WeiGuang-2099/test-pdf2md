<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>PDF âœ Markdown è½¬æ¢å™¨</title>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <div class="container">
    <section class="left card">
      <h2 class="title" style="margin:0 0 8px 0;">PDF âœ Markdown è½¬æ¢å™¨</h2>
      <div id="drop" class="dropzone" tabindex="0">å°† PDF æ‹–æ‹½åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</div>
      <div id="filename" class="filename" style="margin-top:6px;">æœªé€‰æ‹©æ–‡ä»¶</div>
      <input type="file" id="fileInput" accept="application/pdf" style="display:none" />
      
      <!-- å¼•æ“é€‰æ‹© -->
      <div style="margin-top:12px; padding:8px; background:#f5f5f5; border-radius:4px;">
        <label style="font-weight:bold; display:block; margin-bottom:4px;">è½¬æ¢å¼•æ“ï¼š</label>
        <label style="display:inline-block; margin-right:16px; cursor:pointer;">
          <input type="radio" name="engine" value="default" checked> 
          <span>é»˜è®¤å¼•æ“ï¼ˆå¿«é€Ÿï¼‰</span>
        </label>
        <label style="display:inline-block; cursor:pointer;">
          <input type="radio" name="engine" value="nougat"> 
          <span>Nougatï¼ˆå­¦æœ¯è®ºæ–‡æ¨èâ­ï¼‰</span>
        </label>
        <div style="font-size:12px; color:#666; margin-top:4px;">
          ğŸ’¡ Nougat ä¸“ä¸ºå­¦æœ¯è®ºæ–‡ä¼˜åŒ–ï¼Œå®Œç¾å¤„ç†åŒæ å¸ƒå±€å’Œæ•°å­¦å…¬å¼
        </div>
      </div>
      
      <div class="row btn-row" style="margin-top:8px;">
        <button id="chooseBtn" class="btn">é€‰æ‹©æ–‡ä»¶</button>
        <button id="convertBtn" class="btn" disabled>è½¬æ¢</button>
      </div>
      <div id="progress" class="progress" aria-label="è½¬æ¢è¿›åº¦" style="display:none; margin-top:8px;">
        <div class="bar" id="progressBar" style="width:0%"></div>
      </div>
    </section>

    <section class="right card" style="min-height:420px;">
      <div id="mdRaw" class="markdown" style="min-height:200px;"></div>
      <div id="mdPreview" class="markdown-preview" style="min-height:200px; margin-top:8px;"></div>
      <div id="summary" class="summary" style="margin-top:12px;"></div>
      <div id="footer" class="footer-note" style="text-align:center; color:#666; margin-top:6px;">
        å¦‚æœæ—¶é—´ç•™ä¸ä½ï¼Œå°±æŠŠæ€å¿µrunåˆ°æ— é”™å¤„
      </div>
      <div style="margin-top:8px;">
        <button id="copyBtn" class="btn" disabled>å¤åˆ¶è¾“å‡º</button>
        <button id="downloadBtn" class="btn" disabled>ä¸‹è½½.md</button>
      </div>
    </section>
  </div>

  <script>
  // ç®€æ˜“ Markdown -> HTML è½¬æ¢ï¼ˆæç®€å®ç°ï¼Œç”¨äºé¢„è§ˆï¼‰
  function mdToHtml(md){
    if (!md) return '';
    let html = '';
    html += md.split('\n').map(line => {
      if (line.startsWith('## ')) return '<h2>' + line.substring(3) + '</h2>';
      if (line.startsWith('# ')) return '<h1>' + line.substring(2) + '</h1>';
      if (line.trim().length === 0) return '';
      return '<p>' + line + '</p>';
    }).join('');
    return html;
  }

  const drop = document.getElementById('drop');
  const fileInput = document.getElementById('fileInput');
  const chooseBtn = document.getElementById('chooseBtn');
  const convertBtn = document.getElementById('convertBtn');
  const mdArea = document.getElementById('mdRaw');
  const mdPreview = document.getElementById('mdPreview');
  const summaryDiv = document.getElementById('summary');
  const copyBtn = document.getElementById('copyBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const filenameEl = document.getElementById('filename');
  const progress = document.getElementById('progress');
  const progressBar = document.getElementById('progressBar');
  let selectedFile = null;
  let markdownText = '';

  function showFilename(name){ filenameEl.textContent = name ? `å·²é€‰æ‹©: ${name}` : 'æœªé€‰æ‹©æ–‡ä»¶'; }

  function startProgress(){ progress.style.display = 'block'; progressBar.style.width = '0%'; let w = 0; const t = setInterval(()=>{ w += Math.random() * 8 + 2; if (w > 95) w = 95; progressBar.style.width = w.toFixed(0) + '%'; }, 200); return t; }
  function stopProgress(timer){ if (timer) clearInterval(timer); progressBar.style.width = '100%'; setTimeout(()=>{ progress.style.display = 'none'; progressBar.style.width = '0%'; }, 300); }

  drop.addEventListener('dragover', (e)=> { e.preventDefault(); drop.style.borderColor = '#555'; });
  drop.addEventListener('dragleave', ()=> { drop.style.borderColor = '#bbb'; });
  drop.addEventListener('drop', async (e)=> {
    e.preventDefault(); drop.style.borderColor = '#bbb';
    const f = e.dataTransfer.files[0];
    if (f && f.type === 'application/pdf') {
      selectedFile = f;
      showFilename(f.name);
      convertBtn.disabled = false;
      mdArea.innerHTML = '';
      mdPreview.innerHTML = '';
      summaryDiv.innerHTML = '';
    } else {
      showFilename(null);
      alert('è¯·ä¸Šä¼  PDF æ–‡ä»¶');
    }
  });

  drop.addEventListener('click', () => fileInput.click());
  chooseBtn.addEventListener('click', ()=> fileInput.click());
  fileInput.addEventListener('change', () => {
    if (fileInput.files.length > 0) {
      selectedFile = fileInput.files[0];
      showFilename(selectedFile.name);
      convertBtn.disabled = false;
      mdArea.innerHTML = '';
      mdPreview.innerHTML = '';
      summaryDiv.innerHTML = '';
    }
  });

  convertBtn.addEventListener('click', async () => {
    if (!selectedFile) return;
    convertBtn.disabled = true;
    
    // è·å–é€‰æ‹©çš„å¼•æ“
    const engine = document.querySelector('input[name="engine"]:checked').value;
    const endpoint = engine === 'nougat' ? '/convert-nougat' : '/convert';
    
    mdArea.textContent = engine === 'nougat' 
      ? 'æ­£åœ¨ä½¿ç”¨ Nougat è½¬æ¢ï¼ˆé¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦ä¸‹è½½æ¨¡å‹ï¼‰...' 
      : 'æ­£åœ¨è½¬æ¢ï¼Œè¯·ç¨ç­‰...';
    
    const timer = startProgress();
    const form = new FormData();
    form.append('file', selectedFile);

    try {
      const res = await fetch(endpoint, { method: 'POST', body: form });
      if (!res.ok) {
        const errData = await res.json().catch(() => ({ error: 'æœªçŸ¥é”™è¯¯' }));
        mdArea.textContent = 'é”™è¯¯: ' + (errData.error || 'è½¬æ¢å¤±è´¥');
        if (errData.install_guide) {
          mdArea.textContent += '\n\n' + errData.install_guide;
        }
        mdPreview.innerHTML = '';
        summaryDiv.innerHTML = '';
      } else {
        const data = await res.json();
        const md = data.markdown || '';
        markdownText = md;
        
        // æ˜¾ç¤ºä½¿ç”¨çš„æ–¹æ³•
        if (data.method === 'nougat') {
          mdArea.textContent = `[ä½¿ç”¨ Nougat å¼•æ“è½¬æ¢]\n\n${md}`;
        } else {
          mdArea.textContent = md;
        }
        
        if (md && md.length > 0) {
          mdPreview.innerHTML = mdToHtml(md);
        } else {
          mdArea.textContent = '';
          mdPreview.innerHTML = '';
        }
        
        // æ‘˜è¦
        summaryDiv.innerHTML = '';
        const pages = data.pages || [];
        
        if (data.method === 'nougat') {
          // Nougat ç®€åŒ–æ˜¾ç¤º
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `<strong>âœ“ Nougat è½¬æ¢å®Œæˆ</strong><br/>æ–‡æœ¬é•¿åº¦: ${md.length} å­—ç¬¦`;
          summaryDiv.appendChild(card);
        } else {
          // åŸæœ‰çš„è¯¦ç»†æ˜¾ç¤º
          pages.forEach(p => {
            const card = document.createElement('div');
            card.className = 'card';
            let html = `<strong>ç¬¬ ${p.page} é¡µ</strong> â€” æ–‡æœ¬é•¿åº¦ ${p.text_len || 0}ï¼Œè¡¨æ ¼ ${p.table_count || 0}<br/>`;
            if (p.table_details && p.table_details.length) {
              html += '<ul>';
              p.table_details.forEach(td => {
                html += `<li>${td.rows} è¡Œ Ã— ${td.cols} åˆ—</li>`;
              });
              html += '</ul>';
            }
            if (p.images && p.images.length) {
              html += '<div class="image-row">';
              p.images.forEach(src => {
                html += `<img src="${src}" style="height:60px; margin-right:6px; display:inline-block;" />`;
              });
              html += '</div>';
            }
            card.innerHTML = html;
            summaryDiv.appendChild(card);
          });
        }
        
        copyBtn.disabled = false;
        downloadBtn.disabled = false;
      }
    } catch (err) {
      mdArea.textContent = 'ç½‘ç»œæˆ–æœåŠ¡å™¨é”™è¯¯: ' + err.message;
      mdPreview.innerHTML = '';
      summaryDiv.innerHTML = '';
    } finally {
      stopProgress(timer);
      convertBtn.disabled = false;
      copyBtn.disabled = false;
      downloadBtn.disabled = false;
    }
  });

  copyBtn.addEventListener('click', async () => {
    try { await navigator.clipboard.writeText(markdownText); alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'); } catch { }
  });

  downloadBtn.addEventListener('click', () => {
    const blob = new Blob([markdownText], {type: 'text/markdown'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'output.md';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });
</script>
</body>
</html>
